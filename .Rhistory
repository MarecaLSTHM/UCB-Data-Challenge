# Plotting the time series for the entire country(modified)
ggplot(prescription_data_grouped, aes(x = Year, y = Total_Prescriptions, group = 1)) +
geom_line() +
labs(title = "Prescription Trends Over Time",
x = "Year",
y = "Number of Prescriptions") +
theme_minimal()
#Note:information shown just for bisphosphonates
#Trend explainable as 2018 has only data for two months, but generally, drug prescription can be seen to be on a steady decline from peak(2019)
#Comparatively, another plot should be done including all medications
#max 2-3 plots
#Shape file from ONS
regions <- st_read("data/NHSER_APR_2021_EN_BFC.shp")
#arrange alphabetically
regions <- regions%>% arrange(NHSER21NM)
#auto assign region_id(primary key for future merging)
regions <- regions %>%
mutate(region_id = row_number())
#total prescriptions per region
total_prescriptions_by_region <- data11 %>%
group_by(name) %>%
summarise(total_prescriptions = sum(y_items))
#arrange alphabetically to match ONS format
total_prescriptions_by_region <- total_prescriptions_by_region%>% arrange(name)
#auto assign region_id to match ONS
total_prescriptions_by_region <- total_prescriptions_by_region %>%
mutate(region_id = row_number())
region_id <- total_prescriptions_by_region[,c("name","region_id")]
#merge ONS shapefile and our dataset
merged_data <- inner_join(regions, total_prescriptions_by_region, by = "region_id")
#Note this map not so important for Q1, just showing how to merge shapefiles and our transformed data
#Alternatively it can also show us total prescriptions and how it varies by region
#Simulation done only for bisphosphonates
#All medications can be computed as total and graphically represented
# Plotting the map
ggplot(merged_data) +
geom_sf(aes(fill = total_prescriptions), color = "white", lwd = 0.1) +
scale_fill_gradient(low = "orange", high = "red", name = "Total Prescriptions") +
labs(title = "Bisphosphonate 5 years prescription") +
theme_minimal() +
theme(axis.text = element_blank(),
axis.ticks = element_blank())
png(filename = "output/bisphosphates_total_by_UK_region.png", width = 800, height = 600, units = "px", pointsize = 12)
ggplot(merged_data) +
geom_sf(aes(fill = total_prescriptions), color = "white", lwd = 0.1) +
scale_fill_gradient(low = "orange", high = "red", name = "Total Prescriptions") +
labs(title = "Bisphosphonate 5 years prescription") +
theme_minimal() +
theme(axis.text = element_blank(),
axis.ticks = element_blank())
dev.off()
#We can add labels on the regions too for proper identification
df_alendronic_acid=read.csv('data/alendronic_acid.csv')
df_alendronic_acid <- df_alendronic_acid[, c(1,2,3,4)]
names(df_alendronic_acid)[names(df_alendronic_acid) == "y_items"] <- "alendronic_acid"
df_risedronate=read.csv('data/risedronate.csv')
df_risedronate <- df_risedronate[, c(1,2,3,4)]
names(df_risedronate)[names(df_risedronate) == "y_items"] <- "risedronate"
df_etidronate=read.csv('data/etidronate.csv')
df_etidronate <- df_etidronate[, c(1,2,3,4)]
names(df_etidronate)[names(df_etidronate) == "y_items"] <- "etidronate"
df_ibandronic_acid=read.csv('data/ibandronic_acid.csv')
df_ibandronic_acid <- df_ibandronic_acid[, c(1,2,3,4)]
names(df_ibandronic_acid)[names(df_ibandronic_acid) == "y_items"] <- "ibandronic_acid"
df_clodronate=read.csv('data/clodronate.csv')
df_clodronate <- df_clodronate[, c(1,2,3,4)]
names(df_clodronate)[names(df_clodronate) == "y_items"] <- "clodronate"
df_strontium=read.csv('data/strontium.csv')
df_strontium <- df_strontium[, c(1,2,3,4)]
names(df_strontium)[names(df_strontium) == "y_items"] <- "strontium"
df_all_bisphosphates=inner_join(df_alendronic_acid,df_risedronate, by=c("date","name","id"))
df_all_bisphosphates=inner_join(df_all_bisphosphates,df_etidronate, by=c("date","name","id"))
df_all_bisphosphates=inner_join(df_all_bisphosphates,df_ibandronic_acid, by=c("date","name","id"))
df_all_bisphosphates=inner_join(df_all_bisphosphates,df_clodronate, by=c("date","name","id"))
df_all_bisphosphates=inner_join(df_all_bisphosphates,df_strontium, by=c("date","name","id"))
df_all_bisphosphates$date=as.Date(df_all_bisphosphates$date)
df_all_bisphosphates_by_geography<-df_all_bisphosphates %>% group_by(id) %>% summarise(
strontium = sum(strontium),
clodronate = sum(clodronate),
ibandronic_acid = sum(ibandronic_acid),
etidronate = sum(etidronate),
risedronate = sum(risedronate),
alendronic_acid = sum(alendronic_acid),
)
df_all_bisphosphates_by_geography
write.csv(df_all_bisphosphates_by_geography,"output/df_all_bisphosphates_without_geographyy.csv")
df_all_bisphosphates_without_geography<-df_all_bisphosphates %>% group_by(date) %>% summarise(
strontium = sum(strontium),
clodronate = sum(clodronate),
ibandronic_acid = sum(ibandronic_acid),
etidronate = sum(etidronate),
risedronate = sum(risedronate),
alendronic_acid = sum(alendronic_acid),
)
df_all_bisphosphates_without_geography
write.csv(df_all_bisphosphates_without_geography,"output/df_all_bisphosphates_without_geographyy.csv")
df_all_bisphosphates_without_geography <- tidyr::gather(df_all_bisphosphates_without_geography, key = "drug", value = "count", -date)
png(filename="output/bisphosphonates_types.png")
ggplot(df_all_bisphosphates_without_geography, aes(x = date, y = count, color = drug)) +
geom_line() +
geom_point() +
labs(title = "different amount of bisphosphonates",
x = "Date",
y = "Count",
color = "bisphosphate type") +
theme_minimal()
dev.off()
df_BIS=read.csv('data/BISPHOSPHATES_NHS_REGIONS.csv')
df_BIS <- df_BIS[, c(1,2,3,4)]
names(df_BIS)[names(df_BIS) == "y_items"] <- "BIS"
df_CA=read.csv('data/CA+VIT_D_NHS REGIONS.csv')
df_CA <- df_CA[, c(1,2,3,4)]
names(df_CA)[names(df_CA) == "y_items"] <- "CA"
df_PTH=read.csv("data/Calcitonins_PTH_NHS_REGIONS.csv")
df_PTH <- df_PTH[, c(1,2,3,4)]
names(df_PTH)[names(df_PTH) == "y_items"] <- "PTH"
df_deno=read.csv("data/deno_NHS_REGIONS.csv")
df_deno <- df_deno[, c(1,2,3,4)]
names(df_deno)[names(df_deno) == "y_items"] <- "deno"
df_drug=inner_join(df_BIS,df_CA, by=c("date","name","id"))
df_drug=inner_join(df_drug,df_deno, by=c("date","name","id"))
df_drug=inner_join(df_drug,df_PTH, by=c("date","name","id"))
df_drug$date<-as.Date(df_drug$date)
df_drug_by_geography<-df_drug %>% group_by(name) %>% summarise(
BIS = sum(BIS),
CA = sum(CA),
deno = sum(deno),
PTH = sum(PTH)
)
write.csv(df_drug_by_geography,"output/df_drug_by_geography.csv")
df_drug_date<-df_drug %>% group_by(date) %>% summarise(
BIS = sum(BIS),
CA = sum(CA),
deno = sum(deno),
PTH = sum(PTH)
)
df_drug_date_deno<-df_drug_date[, c("date", "deno")]
png("output/denosumab_trend.png")
ggplot(df_drug_date_deno, aes(x = date, y = deno)) +
geom_line() +
geom_point() +
labs(title = "different amount of drug presciption",
x = "Date",
y = "Count",
) +
geom_smooth(method = "lm", se = FALSE, color = "red", size = 1) +
theme_minimal()
dev.off()
df_drug_date <- tidyr::gather(df_drug_date, key = "drug", value = "count", -date)
png(filename = "output/df_all_bisphosphates_without_geography.png")
ggplot(df_all_bisphosphates_without_geography, aes(x = date, y = count, color = drug)) +
geom_line() +
geom_point() +
labs(title = "different amount of drug presciption",
x = "Date",
y = "Count",
color = "drug type") +
theme_minimal()
dev.off()
df_deno=read.csv("data/deno_NHS_REGIONS.csv")
df_deno <- df_deno[, c(1,2,3,4)]
names(df_deno)[names(df_deno) == "y_items"] <- "deno"
df_deno<- df_deno %>% group_by(name) %>% summarise(sum=sum(deno))
df_deno <- inner_join(df_deno, region_id, by = "name")
df_deno<-inner_join(regions, df_deno,by="region_id")
sf_deno <- st_as_sf(df_deno, coords = c("LONG", "LAT"), crs = 4326)
png(file="output/denosumab prescription.png")
ggplot(sf_deno) +
geom_sf(aes(fill = sum), color = "white", lwd = 0.1) +
scale_fill_gradient(low = "orange", high = "red", name = "denosomab prescriptions") +
labs(title = "denosomab 5 years prescription") +
theme_minimal() +
theme(axis.text = element_blank(),
axis.ticks = element_blank())
dev.off()
###yoooo i also did it
dat <- read.csv("data/By Region.csv")
View(dat)
?group_by()
count(dat, name)
?sort()
?sort()
?order()
dat_gr <- group_by(dat, name, date)
View(dat_gr)
summarise(dat, ct = count(name))
library(lubridate)
# Plot the time series graph for the distribution
# Create a time series plot using ggplot2
time_series_plot <- ggplot(data = dat, aes(x = Date, y = y_items)) +
geom_line() +
labs(title = "Time Series Plot",
x = "Date",
y = "Number of prescriptions")
# Display the plot
print(time_series_plot)
dat <- read.csv("data/By Region.csv")
# Create a time series plot using ggplot2
time_series_plot <- ggplot(data = dat, aes(x = Date, y = y_items)) +
geom_line() +
labs(title = "Time Series Plot",
x = "Date",
y = "Number of prescriptions")
# Display the plot
print(time_series_plot)
# Plot the time series graph for the distribution
# Create a time series plot using ggplot2
time_series_plot <- ggplot(data = dat, aes(x = date, y = y_items)) +
geom_line() +
labs(title = "Time Series Plot",
x = "Date",
y = "Number of prescriptions")
# Display the plot
print(time_series_plot)
date_seq <- seq(as.Date(dat$date), by = "months", length.out = 12)
# Convert Date to a date format (in case it's not already)
dat$date <- as.Date(dat$date)
# Plot the time series graph for the distribution
# Create a time series plot using ggplot2
time_series_plot <- ggplot(data = dat, aes(x = paste(Year, Month, sep = "-"), y = y_items)) +
geom_line() +
labs(title = "Time Series Plot",
x = "Date",
y = "Number of prescriptions")
# Display the plot
print(time_series_plot)
# Extract month and year
dat <- dat %>%
mutate(Month = month(date, label = TRUE),
Year = year(date))
# Plot the time series graph for the distribution
# Create a time series plot using ggplot2
time_series_plot <- ggplot(data = dat, aes(x = paste(Year, Month, sep = "-"), y = y_items)) +
geom_line() +
labs(title = "Time Series Plot",
x = "Date",
y = "Number of prescriptions")
# Display the plot
print(time_series_plot)
?subset()
# Create data subsets by regions
data_eoe <- subset(dat, name == "EAST OF ENGLAND COMMISSIONING REGION")
data_ldn <- subset(dat, name == "LONDON COMMISSIONING REGION")
data_mid <- subset(dat, name == "MIDLANDS COMMISSIONING REGION")
data_ney <- subset(dat, name == "NORTH EAST AND YORKSHIRE COMMISSIONING REGION")
data_nw <- subset(dat, name == "NORTH WEST COMMISSIONING REGION")
data_se <- subset(dat, name == "SOUTH EAST COMMISSIONING REGION")
data_sw <- subset(dat, name == "SOUTH WEST COMMISSIONING REGION")
library(tidyverse)
library(lubridate)
# Create synthetic time series datasets
set.seed(123)
# Time series 1
date_seq <- seq(as.Date("2022-01-01"), by = "months", length.out = 12)
time_series_data1 <- data.frame(
Date = date_seq,
Value = cumsum(rnorm(12))
)
# Time series 2
time_series_data2 <- data.frame(
Date = date_seq,
Value = cumsum(rnorm(12, mean = 2, sd = 1))
)
# Combine the datasets
combined_data <- bind_rows(
mutate(time_series_data1, Series = "Series 1"),
mutate(time_series_data2, Series = "Series 2")
)
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = Date, y = Value, color = Series)) +
geom_line() +
labs(title = "Multiple Time Series Plot",
x = "Date",
y = "Value",
color = "Series")
# Display the plot
print(time_series_plot)
# Extract year and months
# Combine the datasets
combined_data <- bind_rows(
mutate(data_eoe, Series = "Series 1"),
mutate(data_ldn, Series = "Series 2"),
mutate(data_mid, Series = "Series 3"),
mutate(data_ney, Series = "Series 4"),
mutate(data_nw, Series = "Series 5"),
mutate(data_se, Series = "Series 6"),
mutate(data_sw, Series = "Series 7")
)
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Series)) +
geom_line() +
labs(title = "Multiple Time Series Plot",
x = "Date",
y = "Value",
color = "Series")
# Display the plot
print(time_series_plot)
# Extract year and months
# Combine the datasets
combined_data <- bind_rows(
mutate(data_eoe, Region = "East of England"),
mutate(data_ldn, Region = "London"),
mutate(data_mid, Region = "Midlands"),
mutate(data_ney, Region = "North East"),
mutate(data_nw, Region = "North West"),
mutate(data_se, Region = "South East"),
mutate(data_sw, Region = "South West")
)
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region)) +
geom_line() +
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region")
# Display the plot
print(time_series_plot)
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region)) +
geom_line() +
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region") +
theme(panel.grid = element_blank())
print(time_series_plot)
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region)) +
geom_line() +
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region") # +
# theme(panel.grid = element_blank())
# Display the plot
print(time_series_plot)
# Calculate the average value for each series
region_avg <- combined_data %>%
group_by(Region) %>%
summarize(avg_value = mean(y_items))
# Order the facets by average value
combined_data$Region <- factor(combined_data$Region,
levels = region_avg$Region[order(region_avg$avg_value)])
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region)) +
geom_line() +
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region") + # +  # theme(panel.grid = element_blank())
facet_wrap(~ Series, scales = "free_y")
# Display the plot
print(time_series_plot)
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region)) +
geom_line() +
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region") + # +  # theme(panel.grid = element_blank())
facet_wrap(~ Region, scales = "free_y")
# Display the plot
print(time_series_plot)
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region)) +
geom_line() +
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region")
# Display the plot
print(time_series_plot)
# Order the color categories by the highest to lowest value
combined_data$Region <- factor(combined_data$Region,
levels = unique(combined_data$Region[order(combined_data$y_items, decreasing = TRUE)]))
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region)) +
geom_line() +
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region")
# Display the plot
print(time_series_plot)
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region)) +
geom_line() +
geom_point() +  # Add data points
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region")
# Display the plot
print(time_series_plot)
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region)) +
geom_line() +
geom_point() +  # Add data points
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region",
shape = "Region")
# Display the plot
print(time_series_plot)
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region)) +
geom_line() +
geom_point() +  # Add data points
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region",
shape = "Region") +
scale_shape_manual(values = c("Midlands" = 16,
"North East" = 17,
"South East" = 18,
"North West" = 19,
"London" = 20,
"East of England" = 21,
"South West"= 22))
# Display the plot
print(time_series_plot)
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region)) +
geom_line() +
geom_point() +  # Add data points
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region",
shape = "Region") +
scale_shape_manual(values = c("Midlands" = 16,
"North East" = 17,
"South East" = 16,
"North West" = 17,
"London" = 16,
"East of England" = 17,
"South West"= 16))
# Display the plot
print(time_series_plot)
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region)) +
geom_line() +
geom_point() +  # Add data points
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region",
shape = "Region") +
scale_shape_manual(y_items = c("Midlands" = 16,
"North East" = 17,
"South East" = 18,
"North West" = 19,
"London" = 20,
"East of England" = 21,
"South West"= 22))
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region)) +
geom_line() +
geom_point() +  # Add data points
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region",
shape = "Region") +
scale_shape_manual(values = c("Midlands" = 16,
"North East" = 17,
"South East" = 18,
"North West" = 19,
"London" = 20,
"East of England" = 21,
"South West"= 22))
# Display the plot
print(time_series_plot)
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region, shape = Region)) +
geom_line() +
geom_point() +
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region",
shape = "Region") +
scale_shape_manual(values = c("Midlands" = 16,
"North East" = 17,
"South East" = 18,
"North West" = 19,
"London" = 20,
"East of England" = 21,
"South West"= 22))
# Display the plot
print(time_series_plot)
# Create a time series plot using ggplot2
time_series_plot <- ggplot(combined_data, aes(x = date, y = y_items, color = Region, shape = Region)) +
geom_line() +
geom_point() +
labs(title = "Prescription of Bisphosphonates in regions of England in the last 5 years",
x = "Date",
y = "Prescriptions",
color = "Region",
shape = "Region") +
scale_shape_manual(values = c("Midlands" = 16,
"North East" = 17,
"South East" = 18,
"North West" = 19,
"London" = 20,
"East of England" = 21,
"South West"= 22)) +
scale_y_continuous(labels = scales::label_number_si())
# Display the plot
print(time_series_plot)
